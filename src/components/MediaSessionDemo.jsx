"use client"

import { useEffect, useState } from "react"

export default function MediaSessionDemo() {
  const [isSupported] = useState("mediaSession" in navigator)
  const [isPlaying, setIsPlaying] = useState(false)
  const [currentTrack, setCurrentTrack] = useState(0)
  const [position, setPosition] = useState(0)
  const [duration, setDuration] = useState(180) // 3 minutes
  const [volume, setVolume] = useState(0.7)
  const [actionHistory, setActionHistory] = useState([])

  const tracks = [
    {
      title: "D√©mo Track 1",
      artist: "Artiste Demo",
      album: "Album Demo",
      artwork: [
        { src: "/placeholder.svg?height=96&width=96", sizes: "96x96", type: "image/svg+xml" },
        { src: "/placeholder.svg?height=128&width=128", sizes: "128x128", type: "image/svg+xml" },
        { src: "/placeholder.svg?height=192&width=192", sizes: "192x192", type: "image/svg+xml" },
        { src: "/placeholder.svg?height=256&width=256", sizes: "256x256", type: "image/svg+xml" },
      ],
    },
    {
      title: "D√©mo Track 2",
      artist: "Autre Artiste",
      album: "Autre Album",
      artwork: [
        { src: "/placeholder.svg?height=96&width=96", sizes: "96x96", type: "image/svg+xml" },
        { src: "/placeholder.svg?height=128&width=128", sizes: "128x128", type: "image/svg+xml" },
      ],
    },
    {
      title: "D√©mo Track 3",
      artist: "Troisi√®me Artiste",
      album: "Troisi√®me Album",
      artwork: [{ src: "/placeholder.svg?height=96&width=96", sizes: "96x96", type: "image/svg+xml" }],
    },
  ]

  const addToHistory = (action, details) => {
    setActionHistory((prev) => [
      {
        id: Date.now(),
        action,
        details,
        timestamp: new Date().toLocaleTimeString(),
      },
      ...prev.slice(0, 9),
    ])
  }

  useEffect(() => {
    if (!isSupported) return

    // Configurer les m√©tadonn√©es du m√©dia
    const track = tracks[currentTrack]
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title,
      artist: track.artist,
      album: track.album,
      artwork: track.artwork,
    })

    // Configurer les actions disponibles
    const actionHandlers = {
      play: () => {
        setIsPlaying(true)
        addToHistory("‚ñ∂Ô∏è Play", "Lecture d√©marr√©e via contr√¥les syst√®me")
      },
      pause: () => {
        setIsPlaying(false)
        addToHistory("‚è∏Ô∏è Pause", "Lecture mise en pause via contr√¥les syst√®me")
      },
      previoustrack: () => {
        const newTrack = currentTrack > 0 ? currentTrack - 1 : tracks.length - 1
        setCurrentTrack(newTrack)
        setPosition(0)
        addToHistory("‚èÆÔ∏è Previous", `Piste pr√©c√©dente: ${tracks[newTrack].title}`)
      },
      nexttrack: () => {
        const newTrack = currentTrack < tracks.length - 1 ? currentTrack + 1 : 0
        setCurrentTrack(newTrack)
        setPosition(0)
        addToHistory("‚è≠Ô∏è Next", `Piste suivante: ${tracks[newTrack].title}`)
      },
      seekbackward: (details) => {
        const seekTime = details.seekOffset || 10
        const newPosition = Math.max(0, position - seekTime)
        setPosition(newPosition)
        addToHistory("‚è™ Seek Back", `Retour de ${seekTime}s`)
      },
      seekforward: (details) => {
        const seekTime = details.seekOffset || 10
        const newPosition = Math.min(duration, position + seekTime)
        setPosition(newPosition)
        addToHistory("‚è© Seek Forward", `Avance de ${seekTime}s`)
      },
      seekto: (details) => {
        if (details.seekTime !== undefined) {
          setPosition(details.seekTime)
          addToHistory("üéØ Seek To", `Position: ${Math.round(details.seekTime)}s`)
        }
      },
      stop: () => {
        setIsPlaying(false)
        setPosition(0)
        addToHistory("‚èπÔ∏è Stop", "Lecture arr√™t√©e via contr√¥les syst√®me")
      },
    }

    // Enregistrer les gestionnaires d'actions
    Object.entries(actionHandlers).forEach(([action, handler]) => {
      try {
        navigator.mediaSession.setActionHandler(action, handler)
      } catch (error) {
        console.log(`Action ${action} non support√©e:`, error)
      }
    })

    return () => {
      // Nettoyer les gestionnaires
      Object.keys(actionHandlers).forEach((action) => {
        try {
          navigator.mediaSession.setActionHandler(action, null)
        } catch (error) {
          // Ignorer les erreurs de nettoyage
        }
      })
    }
  }, [currentTrack, position, duration, isSupported])

  useEffect(() => {
    if (!isSupported) return

    // Mettre √† jour la position de lecture
    navigator.mediaSession.setPositionState({
      duration: duration,
      playbackRate: 1.0,
      position: position,
    })
  }, [position, duration, isSupported])

  // Simuler la progression de la lecture
  useEffect(() => {
    if (!isPlaying) return

    const interval = setInterval(() => {
      setPosition((prev) => {
        if (prev >= duration) {
          // Passer √† la piste suivante
          const nextTrack = currentTrack < tracks.length - 1 ? currentTrack + 1 : 0
          setCurrentTrack(nextTrack)
          addToHistory("üîÑ Auto Next", `Piste suivante automatique: ${tracks[nextTrack].title}`)
          return 0
        }
        return prev + 1
      })
    }, 1000)

    return () => clearInterval(interval)
  }, [isPlaying, duration, currentTrack, tracks])

  const togglePlayPause = () => {
    const newState = !isPlaying
    setIsPlaying(newState)
    addToHistory(newState ? "‚ñ∂Ô∏è Play" : "‚è∏Ô∏è Pause", "Action depuis l'interface web")
  }

  const previousTrack = () => {
    const newTrack = currentTrack > 0 ? currentTrack - 1 : tracks.length - 1
    setCurrentTrack(newTrack)
    setPosition(0)
    addToHistory("‚èÆÔ∏è Previous", `Interface web: ${tracks[newTrack].title}`)
  }

  const nextTrack = () => {
    const newTrack = currentTrack < tracks.length - 1 ? currentTrack + 1 : 0
    setCurrentTrack(newTrack)
    setPosition(0)
    addToHistory("‚è≠Ô∏è Next", `Interface web: ${tracks[newTrack].title}`)
  }

  const seekTo = (newPosition) => {
    setPosition(newPosition)
    addToHistory("üéØ Seek", `Position: ${Math.round(newPosition)}s`)
  }

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, "0")}`
  }

  const clearHistory = () => {
    setActionHistory([])
  }

  if (!isSupported) {
    return (
      <div>
        <div className="demo-header">
          <h2 className="demo-title">üé¨ Media Session API</h2>
          <p className="demo-description">Contr√¥les m√©dia syst√®me int√©gr√©s.</p>
        </div>

        <div className="demo-section">
          <div className="status-indicator offline">‚ùå Media Session API non support√©e</div>
        </div>
      </div>
    )
  }

  const track = tracks[currentTrack]

  return (
    <div>
      <div className="demo-header">
        <h2 className="demo-title">üé¨ Media Session API</h2>
        <p className="demo-description">
          Int√©grez vos contr√¥les m√©dia avec le syst√®me. Affichez les m√©tadonn√©es dans les notifications et contr√¥lez
          depuis les raccourcis clavier.
        </p>
      </div>

      <div className="demo-section">
        <h3>Lecteur M√©dia</h3>
        <div className="card" style={{ textAlign: "center", padding: "2rem" }}>
          <div style={{ marginBottom: "1rem" }}>
            <img
              src="/placeholder.svg?height=200&width=200"
              alt="Album artwork"
              style={{
                width: "200px",
                height: "200px",
                borderRadius: "8px",
                boxShadow: "0 4px 12px rgba(0,0,0,0.1)",
              }}
            />
          </div>

          <h3 style={{ margin: "0.5rem 0", fontSize: "1.5rem" }}>{track.title}</h3>
          <p style={{ margin: "0.5rem 0", color: "#666" }}>{track.artist}</p>
          <p style={{ margin: "0.5rem 0", color: "#888", fontSize: "0.9rem" }}>{track.album}</p>

          <div style={{ margin: "1.5rem 0" }}>
            <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
              <span style={{ fontSize: "0.9rem", color: "#666" }}>{formatTime(position)}</span>
              <input
                type="range"
                min="0"
                max={duration}
                value={position}
                onChange={(e) => seekTo(Number(e.target.value))}
                style={{ flex: 1 }}
              />
              <span style={{ fontSize: "0.9rem", color: "#666" }}>{formatTime(duration)}</span>
            </div>
          </div>

          <div style={{ display: "flex", justifyContent: "center", gap: "1rem" }}>
            <button className="btn" onClick={previousTrack} style={{ fontSize: "1.2rem" }}>
              ‚èÆÔ∏è
            </button>
            <button
              className={`btn ${isPlaying ? "danger" : "success"}`}
              onClick={togglePlayPause}
              style={{ fontSize: "1.2rem", width: "60px" }}
            >
              {isPlaying ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è"}
            </button>
            <button className="btn" onClick={nextTrack} style={{ fontSize: "1.2rem" }}>
              ‚è≠Ô∏è
            </button>
          </div>

          <div style={{ marginTop: "1.5rem", display: "flex", alignItems: "center", gap: "0.5rem" }}>
            <span style={{ fontSize: "0.9rem", color: "#666" }}>üîà</span>
            <input
              type="range"
              min="0"
              max="1"
              step="0.01"
              value={volume}
              onChange={(e) => setVolume(Number(e.target.value))}
              style={{ width: "100px" }}
            />
            <span style={{ fontSize: "0.9rem", color: "#666" }}>üîä</span>
          </div>
        </div>
      </div>

      <div className="demo-section">
        <h3>Contr√¥les Syst√®me</h3>
        <div className="demo-output">
          {`üéÆ Contr√¥les disponibles:
- ‚ñ∂Ô∏è/‚è∏Ô∏è Play/Pause: Contr√¥les syst√®me, raccourcis m√©dia
- ‚èÆÔ∏è/‚è≠Ô∏è Pr√©c√©dent/Suivant: Boutons physiques, notifications
- ‚è™/‚è© Retour/Avance rapide: Raccourcis clavier
- üéØ Seek: Barre de progression syst√®me

üì± O√π les trouver:
- Centre de contr√¥le iOS/Android
- √âcran de verrouillage
- Barre des t√¢ches Windows/macOS
- Notifications syst√®me
- Raccourcis clavier m√©dia

üí° Conseil: Testez avec les touches m√©dia de votre clavier ou le centre de contr√¥le de votre appareil mobile`}
        </div>
      </div>

      <div className="demo-section">
        <h3>Historique des Actions</h3>
        <div className="demo-controls">
          <button className="btn danger" onClick={clearHistory}>
            üóëÔ∏è Effacer Historique
          </button>
        </div>

        <div
          style={{
            maxHeight: "300px",
            overflowY: "auto",
            border: "2px solid #ddd",
            borderRadius: "12px",
            padding: "1rem",
            backgroundColor: "#f8f9fa",
            marginTop: "1rem",
          }}
        >
          {actionHistory.length === 0 ? (
            <p style={{ textAlign: "center", color: "#666", fontStyle: "italic" }}>
              Utilisez les contr√¥les pour voir l'historique
            </p>
          ) : (
            actionHistory.map((event) => (
              <div
                key={event.id}
                style={{
                  padding: "0.75rem",
                  margin: "0.5rem 0",
                  borderRadius: "8px",
                  backgroundColor: "#fff",
                  border: "1px solid #ddd",
                  animation: "slideIn 0.3s ease",
                }}
              >
                <div style={{ fontSize: "0.9rem", fontWeight: "bold" }}>{event.action}</div>
                <div style={{ fontSize: "0.8rem", color: "#666" }}>
                  {event.details} | {event.timestamp}
                </div>
              </div>
            ))
          )}
        </div>
      </div>

      <div className="demo-section">
        <h3>Applications Pratiques</h3>
        <div className="grid">
          <div className="card">
            <h4>üéµ Streaming Audio</h4>
            <p>Contr√¥les syst√®me pour services de musique</p>
          </div>
          <div className="card">
            <h4>üéûÔ∏è Vid√©o</h4>
            <p>Contr√¥le de lecture vid√©o depuis le syst√®me</p>
          </div>
          <div className="card">
            <h4>üéôÔ∏è Podcasts</h4>
            <p>Navigation facile dans les √©pisodes</p>
          </div>
          <div className="card">
            <h4>üìö Audiobooks</h4>
            <p>Contr√¥le de la narration depuis l'√©cran de verrouillage</p>
          </div>
        </div>
      </div>

      <style jsx>{`
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(-20px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
      `}</style>
    </div>
  )
}
